name: CI/CD Production Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Job ki·ªÉm tra thay ƒë·ªïi c·ªßa t·ª´ng service
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      api-gateway: ${{ steps.changes.outputs.api-gateway }}
      auth-service: ${{ steps.changes.outputs.auth-service }}
      user-service: ${{ steps.changes.outputs.user-service }}
      product-service: ${{ steps.changes.outputs.product-service }}
      order-service: ${{ steps.changes.outputs.order-service }}
      payment-service: ${{ steps.changes.outputs.payment-service }}
      notification-service: ${{ steps.changes.outputs.notification-service }}
      analytics-service: ${{ steps.changes.outputs.analytics-service }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            api-gateway:
              - 'api_gateway/**'
              - 'shared_code/**'
            auth-service:
              - 'auth_service/**'
              - 'shared_code/**'
            user-service:
              - 'user_service/**'
              - 'shared_code/**'
            product-service:
              - 'product_service/**'
              - 'shared_code/**'
            order-service:
              - 'order_service/**'
              - 'shared_code/**'
            payment-service:
              - 'payment_service/**'
              - 'shared_code/**'
            notification-service:
              - 'notification_service/**'
              - 'shared_code/**'
            analytics-service:
              - 'analytics_service/**'
              - 'shared_code/**'

  # Test v√† Build cho API Gateway
  api-gateway:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.api-gateway == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          cd api_gateway
          pip install -r requirements.txt
          
      - name: Code quality checks
        run: |
          cd api_gateway
          ruff format --check .
          ruff check .
          
      - name: Security checks
        run: |
          cd api_gateway
          bandit -r . -f json -o bandit-report.json || true
          safety check || true
          
      - name: Run tests
        run: |
          cd api_gateway
          pytest --cov=. --cov-report=xml
          
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./api_gateway
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/api-gateway:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/api-gateway:${{ github.sha }}

  # Test v√† Build cho Auth Service
  auth-service:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.auth-service == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          cd auth_service
          pip install -r requirements.txt
          
      - name: Code quality checks
        run: |
          cd auth_service
          ruff format --check .
          ruff check .
          
      - name: Security checks
        run: |
          cd auth_service
          bandit -r . -f json -o bandit-report.json || true
          safety check || true
          
      - name: Run tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        run: |
          cd auth_service
          pytest --cov=. --cov-report=xml
          
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./auth_service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/auth-service:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/auth-service:${{ github.sha }}

  # Test v√† Build cho User Service
  user-service:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.user-service == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          cd user_service
          pip install -r requirements.txt
          
      - name: Code quality checks
        run: |
          cd user_service
          ruff format --check .
          ruff check .
          
      - name: Security checks
        run: |
          cd user_service
          bandit -r . -f json -o bandit-report.json || true
          safety check || true
          
      - name: Run tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        run: |
          cd user_service
          pytest --cov=. --cov-report=xml
          
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./user_service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/user-service:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/user-service:${{ github.sha }}

  # Test v√† Build cho Product Service
  product-service:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.product-service == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
        env:
          discovery.type: single-node
          xpack.security.enabled: false
        ports:
          - 9200:9200
          
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          cd product_service
          pip install -r requirements.txt
          
      - name: Code quality checks
        run: |
          cd product_service
          ruff format --check .
          ruff check .
          
      - name: Security checks
        run: |
          cd product_service
          bandit -r . -f json -o bandit-report.json || true
          safety check || true
          
      - name: Run tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          ELASTICSEARCH_URL: http://localhost:9200
        run: |
          cd product_service
          pytest --cov=. --cov-report=xml
          
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./product_service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/product-service:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/product-service:${{ github.sha }}

  # Test v√† Build cho Order Service
  order-service:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.order-service == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
          
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          cd order_service
          pip install -r requirements.txt
          
      - name: Code quality checks
        run: |
          cd order_service
          ruff format --check .
          ruff check .
          
      - name: Security checks
        run: |
          cd order_service
          bandit -r . -f json -o bandit-report.json || true
          safety check || true
          
      - name: Run tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379
        run: |
          cd order_service
          pytest --cov=. --cov-report=xml
          
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./order_service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/order-service:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/order-service:${{ github.sha }}

  # Test v√† Build cho Payment Service
  payment-service:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.payment-service == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          cd payment_service
          pip install -r requirements.txt
          
      - name: Code quality checks
        run: |
          cd payment_service
          ruff format --check .
          ruff check .
          
      - name: Security checks
        run: |
          cd payment_service
          bandit -r . -f json -o bandit-report.json || true
          safety check || true
          
      - name: Run tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        run: |
          cd payment_service
          pytest --cov=. --cov-report=xml
          
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./payment_service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/payment-service:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/payment-service:${{ github.sha }}

  # Test v√† Build cho Notification Service
  notification-service:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.notification-service == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
          
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          cd notification_service
          pip install -r requirements.txt
          
      - name: Code quality checks
        run: |
          cd notification_service
          ruff format --check .
          ruff check .
          
      - name: Security checks
        run: |
          cd notification_service
          bandit -r . -f json -o bandit-report.json || true
          safety check || true
          
      - name: Run tests
        env:
          REDIS_URL: redis://localhost:6379
        run: |
          cd notification_service
          pytest --cov=. --cov-report=xml
          
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./notification_service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/notification-service:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/notification-service:${{ github.sha }}

  # Test v√† Build cho Analytics Service
  analytics-service:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.analytics-service == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          cd analytics_service
          pip install -r requirements.txt
          
      - name: Code quality checks
        run: |
          cd analytics_service
          ruff format --check .
          ruff check .
          
      - name: Security checks
        run: |
          cd analytics_service
          bandit -r . -f json -o bandit-report.json || true
          safety check || true
          
      - name: Run tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        run: |
          cd analytics_service
          pytest --cov=. --cov-report=xml
          
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./analytics_service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/analytics-service:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/analytics-service:${{ github.sha }}

  # Deploy to Production
  deploy-production:
    needs: [
      detect-changes,
      api-gateway,
      auth-service, 
      user-service,
      product-service,
      order-service,
      payment-service,
      notification-service,
      analytics-service
    ]
    if: |
      always() && 
      github.ref == 'refs/heads/main' &&
      (
        (needs.detect-changes.outputs.api-gateway != 'true' || needs.api-gateway.result == 'success') &&
        (needs.detect-changes.outputs.auth-service != 'true' || needs.auth-service.result == 'success') &&
        (needs.detect-changes.outputs.user-service != 'true' || needs.user-service.result == 'success') &&
        (needs.detect-changes.outputs.product-service != 'true' || needs.product-service.result == 'success') &&
        (needs.detect-changes.outputs.order-service != 'true' || needs.order-service.result == 'success') &&
        (needs.detect-changes.outputs.payment-service != 'true' || needs.payment-service.result == 'success') &&
        (needs.detect-changes.outputs.notification-service != 'true' || needs.notification-service.result == 'success') &&
        (needs.detect-changes.outputs.analytics-service != 'true' || needs.analytics-service.result == 'success')
      ) &&
      (
        needs.detect-changes.outputs.api-gateway == 'true' ||
        needs.detect-changes.outputs.auth-service == 'true' ||
        needs.detect-changes.outputs.user-service == 'true' ||
        needs.detect-changes.outputs.product-service == 'true' ||
        needs.detect-changes.outputs.order-service == 'true' ||
        needs.detect-changes.outputs.payment-service == 'true' ||
        needs.detect-changes.outputs.notification-service == 'true' ||
        needs.detect-changes.outputs.analytics-service == 'true'
      )
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to Production
        run: |
          echo "üöÄ Deploying to production environment..."
          chmod +x ./scripts/deploy.sh
          ./scripts/deploy.sh production
          
      - name: Run Health Checks
        run: |
          echo "üîç Running production health checks..."
          chmod +x ./scripts/health-check.sh
          ./scripts/health-check.sh production
          
      - name: Notify Deployment
        run: |
          echo "‚úÖ Production deployment completed successfully!"
          echo "üì¶ Services deployed: $(echo '${{ needs.detect-changes.outputs }}' | jq -r 'to_entries[] | select(.value == "true") | .key' | tr '\n' ' ')"
          echo "üîó Commit: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          # Add notification logic here (Slack, email, etc.)